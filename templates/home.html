{% extends 'base.html' %}

{% block title %}Statute of Limitations Calculator | StatuteChecker{% endblock %}

{% block content %}
<div class="hero-section text-center">
    <div class="row justify-content-center">
        <div class="col-lg-9 col-md-11">

            <h1 class="display-4 fw-bold mb-3">Statute of Limitations Verification</h1>
            <p class="lead text-slate mb-5">
                The authoritative resource for civil deadline calculations.
            </p>
            
            <div class="card border-0 p-4 p-md-5 text-start shadow-diffused">
                <div id="formAlert" class="alert alert-danger d-none shadow-sm border-0 rounded-0 mb-4" role="alert">
                    <span id="alertMessage"></span>
                </div>

                <form id="searchForm">
                    <div class="row g-4 align-items-end">
                        <div class="col-md-5">
                            <label for="stateSelect" class="form-label fw-bold text-uppercase small text-muted ls-1">1. Jurisdiction</label>
                            <select class="form-select form-select-lg" id="stateSelect" required>
                                <option value="" selected disabled>Select State...</option>
                                {% for state in states %}
                                <option value="{{ state.slug }}">{{ state.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-5">
                            <label class="form-label fw-bold text-uppercase small text-muted ls-1">2. Case Type</label>
                            
                            <input type="hidden" id="issueSlug" name="issueSlug" required>
                            
                            <div class="dropdown w-100">
                                <button class="form-select form-select-lg w-100 text-start text-truncate" 
                                        type="button" 
                                        id="issueDropdownBtn" 
                                        data-bs-toggle="dropdown" 
                                        data-bs-auto-close="outside"
                                        aria-expanded="false">
                                    <span id="issueBtnText">Select State first...</span>
                                </button>
                                
                                <div class="dropdown-menu w-100 p-0 shadow border-0 mt-1" aria-labelledby="issueDropdownBtn">
                                    <div class="p-2 border-bottom bg-light sticky-top">
                                        <div class="input-group input-group-sm">
                                            <span class="input-group-text bg-white border-end-0"><i class="fas fa-search text-muted"></i></span>
                                            <input type="text" id="issueSearchInput" class="form-control border-start-0" placeholder="Type to filter..." autocomplete="off">
                                        </div>
                                    </div>
                                    
                                    <div id="issueListContainer" style="max-height: 300px; overflow-y: auto;">
                                        <div class="p-3 text-muted small text-center">Please select a jurisdiction first.</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-2">
                            <button type="button" onclick="performSearch()" class="btn btn-primary w-100 btn-lg">
                                Check
                            </button>
                        </div>
                    </div>

                    <div id="quickPillsRow" class="row mt-3 d-none">
                        <div class="col-12">
                            <div class="d-flex flex-wrap gap-2" id="quickPillsContainer">
                                </div>
                        </div>
                    </div>
                </form>
            </div>
            </div>
    </div>
</div>

<script>
    const stateSelect = document.getElementById('stateSelect');
    const issueDropdownBtn = document.getElementById('issueDropdownBtn');
    const issueBtnText = document.getElementById('issueBtnText');
    const issueListContainer = document.getElementById('issueListContainer');
    const issueSearchInput = document.getElementById('issueSearchInput');
    const issueSlugInput = document.getElementById('issueSlug');
    const quickPillsRow = document.getElementById('quickPillsRow');
    const quickPillsContainer = document.getElementById('quickPillsContainer');
    const formAlert = document.getElementById('formAlert');
    const alertMessage = document.getElementById('alertMessage');
    
    let allIssuesData = []; 

    const PILL_MAPPING = {
        'Personal Injury (General Negligence)': 'Personal Injury',
        'Breach of Contract â€“ Written': 'Contract',
        'Medical Malpractice': 'Medical Malpractice',
        'Debt Collection': 'Debt',
        'Business Torts (Fraud, Misrepresentation)': 'Fraud'
    };

    const dropdownElement = document.getElementById('issueDropdownBtn');
    dropdownElement.addEventListener('shown.bs.dropdown', function () {
        issueSearchInput.focus();
    });

    stateSelect.addEventListener('change', function() {
        const stateSlug = this.value;
        hideAlert();
        issueBtnText.textContent = "Loading...";
        issueSlugInput.value = "";
        quickPillsRow.classList.add('d-none');
        issueListContainer.innerHTML = '<div class="p-3 text-muted small text-center">Loading registry...</div>';
        issueSearchInput.value = "";
        
        if (stateSlug) {
            fetch(`/api/issues/${stateSlug}`)
                .then(response => response.json())
                .then(data => {
                    allIssuesData = data;
                    if (data.length > 0) {
                        renderDropdownItems(data);
                        renderQuickPills(data);
                        issueBtnText.textContent = "Select Case Type...";
                    } else {
                        issueBtnText.textContent = "No issues found";
                        issueListContainer.innerHTML = '<div class="p-3 text-muted small text-center">No data available.</div>';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    issueBtnText.textContent = "System Error";
                });
        }
    });

    function renderQuickPills(items) {
        quickPillsContainer.innerHTML = '';
        let count = 0;
        const availableIssues = {};
        items.forEach(i => availableIssues[i.name] = i);

        for (const [dbName, displayName] of Object.entries(PILL_MAPPING)) {
            if (availableIssues[dbName] && count < 5) {
                const issue = availableIssues[dbName];
                const pill = document.createElement('button');
                pill.type = 'button';
                pill.className = 'btn btn-sm btn-pill-custom fade-in-up';
                pill.textContent = displayName;
                // PILL CLICK: Selects issue AND triggers search immediately
                pill.onclick = () => {
                    selectIssue(issue);
                    performSearch();
                };
                quickPillsContainer.appendChild(pill);
                count++;
            }
        }
        if (count > 0) {
            quickPillsRow.classList.remove('d-none');
        }
    }

    issueSearchInput.addEventListener('input', function(e) {
        const term = e.target.value.toLowerCase();
        const filtered = allIssuesData.filter(item => item.name.toLowerCase().includes(term));
        renderDropdownItems(filtered);
    });

    function renderDropdownItems(items) {
        issueListContainer.innerHTML = "";
        if (items.length === 0) {
            issueListContainer.innerHTML = '<div class="dropdown-item text-muted disabled">No matches found</div>';
            return;
        }

        const grouped = {};
        const ungrouped = [];

        items.forEach(item => {
            if (item.issue_group) {
                if (!grouped[item.issue_group]) {
                    grouped[item.issue_group] = [];
                }
                grouped[item.issue_group].push(item);
            } else {
                ungrouped.push(item);
            }
        });

        const sortById = (a, b) => a.id - b.id;
        ungrouped.sort(sortById);
        const sortedGroupKeys = Object.keys(grouped).sort();

        sortedGroupKeys.forEach(groupName => {
            const header = document.createElement('div');
            header.className = "dropdown-header fw-bold text-uppercase small mt-2 text-primary opacity-75";
            header.textContent = groupName;
            issueListContainer.appendChild(header);
            
            grouped[groupName].sort(sortById);
            grouped[groupName].forEach(issue => {
                issueListContainer.appendChild(createDropdownItem(issue));
            });
        });

        if (ungrouped.length > 0) {
            if (sortedGroupKeys.length > 0) {
                const header = document.createElement('div');
                header.className = "dropdown-header fw-bold text-uppercase small mt-2 text-primary opacity-75";
                header.textContent = "Other";
                issueListContainer.appendChild(header);
            }
            ungrouped.forEach(issue => {
                issueListContainer.appendChild(createDropdownItem(issue));
            });
        }
    }

    function createDropdownItem(issue) {
        const a = document.createElement('button');
        a.type = 'button';
        a.className = "dropdown-item py-2 text-wrap";
        a.textContent = issue.name;
        // DROPDOWN ITEM CLICK: Selects issue AND hides dropdown
        a.onclick = () => {
            selectIssue(issue);
            
            // Programmatically hide the dropdown
            const dropdownToggle = document.getElementById('issueDropdownBtn');
            const dropdownInstance = bootstrap.Dropdown.getInstance(dropdownToggle);
            if (dropdownInstance) {
                dropdownInstance.hide();
            }
        };
        return a;
    }

    function selectIssue(issue) {
        hideAlert();
        issueSlugInput.value = issue.slug;
        issueBtnText.textContent = issue.name;
    }

    function showAlert(msg) {
        alertMessage.textContent = msg;
        formAlert.classList.remove('d-none');
    }

    function hideAlert() {
        formAlert.classList.add('d-none');
    }

    function performSearch() {
        const state = stateSelect.value;
        const issue = issueSlugInput.value;
        if (state && issue) {
            window.location.href = `/limitations/${state}/${issue}`;
        } else {
            let msg = "Please select a State and a Legal Issue to continue.";
            if (!state) msg = "Please select a Jurisdiction first.";
            else if (!issue) msg = "Please select a Case Type.";
            showAlert(msg);
        }
    }
</script>
{% endblock %}